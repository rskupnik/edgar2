<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Edgar Dashboard</title>
    <link th:href="@{main.css}" rel="stylesheet" />
    <script src="https://unpkg.com/vue"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</head>
<body>
<div id="app">

<!--    <device-widget v-bind:device="{'name': 'Room fan #1', 'endpoints': [{'name': 'Basic speed', 'type': 'toggle'}]}"></device-widget>-->
<!--    <device-widget v-bind:device="{'name': 'Room fan #2', 'endpoints': [{'type': 'toggle-large'}]}"></device-widget>-->

    <div v-for="device in devices">
        <device-widget v-bind:device="device"></device-widget>
    </div>

<!--    <div v-for="device in devices" class="device">-->
<!--        <h1>{{ device.name }}</h1>-->
<!--        <div v-for="endpoint in device.endpoints" class="endpoint">-->
<!--            <button v-on:click="sendCommand(device, endpoint)">{{ endpoint.path }}</button>-->
<!--            <span>{{ endpoint.description }}</span>-->
<!--        </div>-->
<!--    </div>-->
</div>

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
    <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 150 150" id="line">
        <line x1="75" y1="34" x2="75" y2="58"/>
    </symbol>
    <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 150 150" id="circle">
        <circle cx="75" cy="80" r="35"/>
    </symbol>
</svg>

<script>
    Vue.component('device-widget', {
        props: ['device'],
        template: `
            <div class="deviceContainer">
                <h1>{{ device.name }}</h1>
                <div class="endpoints">
                    <div v-for="endpoint in device.endpoints">
                        <basic-toggle-endpoint v-if="endpoint.type === 'default'" :device="device" :endpoint="endpoint"></basic-toggle-endpoint>
                        <large-toggle-endpoint v-if="endpoint.type === 'toggle-large'" :device="device" :endpoint="endpoint"></large-toggle-endpoint>
                    </div>
                </div>
            </div>
        `
    })

    Vue.component('basic-toggle-endpoint', {
        props: ['endpoint', 'device'],
        template: `
            <div class="singleEndpoint">
                <label class="toggle-control">
                    <input type="checkbox" v-on:change="$root.sendCommand(device, endpoint)" v-model="device.status.endpoints[endpoint.path].enabled"/>
                    <span class="control"></span>
                </label>
                <span class="endpointToggleDescription">{{ endpoint.path }}</span>
                {{ device.status.endpoints[endpoint.path].enabled }}
            </div>
        `
    })

    Vue.component('large-toggle-endpoint', {
        props: ['endpoint', 'device'],
        template: `
            <div class="power-switch">
                <input type="checkbox" v-on:change="$root.sendCommand(device, endpoint)" v-model="device.status.endpoints[endpoint.path].enabled"/>
                <div class="button">
                    <svg class="power-off">
                        <use xlink:href="#line" class="line" />
                        <use xlink:href="#circle" class="circle" />
                    </svg>
                    <svg class="power-on">
                        <use xlink:href="#line" class="line" />
                        <use xlink:href="#circle" class="circle" />
                    </svg>
                </div>
            </div>
        `
    })

    var app = new Vue({
        el: '#app',
        data() {
            return {
                devices: null,
                testDevices: [
                    {
                        "name": "Test device #1",
                        "endpoints": [
                            {
                                "name": "Basic speed",
                                "type": "basic"
                            }
                        ]
                    }
                ]
            }
        },
        mounted() {
            axios
                .get('http://' + window.location.host + '/devices')
                .then(response => (this.devices = response.data))
        },
        methods: {
            sendCommand: function (device, endpoint) {
                console.log(endpoint)
                axios.post("http://" + window.location.host + "/devices/" + device.id + endpoint.path)
            }
        }
    })
</script>
</body>
</html>
